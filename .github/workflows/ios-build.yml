name: ğŸ iOS Build for Sideloadly

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-ios:
    name: ğŸ“± Build Sukinime iOS
    runs-on: macos-13
    
    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ğŸ“¥ CHECKOUT & SETUP
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      - name: ğŸ“¦ Install Flutter Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          flutter pub get
          echo ""
          echo "ğŸ” Flutter Doctor:"
          flutter doctor -v

      - name: ğŸ› ï¸ Setup Xcode 15.0
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: ğŸ Install CocoaPods Dependencies
        run: |
          echo "ğŸ Installing iOS native dependencies..."
          cd ios
          pod install --repo-update
          cd ..
          echo "âœ… CocoaPods installation complete"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ğŸ—ï¸ BUILD PROCESS
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ—ï¸ Build iOS App (Unsigned for Sideloadly)
        run: |
          echo "ğŸ§¹ Cleaning previous builds..."
          flutter clean
          flutter pub get
          
          echo ""
          echo "ğŸ—ï¸ Building iOS app (Release mode - No code signing)..."
          flutter build ios --release --no-codesign
          
          echo ""
          echo "ğŸ“¦ Creating IPA structure..."
          mkdir -p Payload
          
          echo "ğŸ“‹ Copying app bundle to Payload..."
          cp -r build/ios/iphoneos/Runner.app Payload/
          
          echo "ğŸ—œï¸ Compressing to IPA format..."
          zip -r Sukinime-iOS.ipa Payload
          
          echo "ğŸ“ Organizing build artifacts..."
          mkdir -p build/ios/ipa
          mv Sukinime-iOS.ipa build/ios/ipa/
          
          echo ""
          echo "âœ… IPA build complete!"
          ls -lh build/ios/ipa/

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ğŸ“¤ UPLOAD & RELEASE
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“¤ Upload IPA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sukinime-iOS-v${{ github.run_number }}
          path: build/ios/ipa/Sukinime-iOS.ipa
          retention-days: 30
          if-no-files-found: error

      - name: ğŸ‰ Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v1.0.${{ github.run_number }}
          name: ğŸ Sukinime iOS v1.0.${{ github.run_number }}
          body: |
            # ğŸ“± Sukinime - iOS Build (Unsigned)
            
            > **âš¡ Ready for Sideloadly installation!**
            
            ---
            
            ## ğŸ“¥ Installation via Sideloadly
            
            ### ğŸ“‹ Requirements
            - âœ… iPhone/iPad with **iOS 12.0** or higher
            - âœ… **Sideloadly** installed on Windows/Mac ([Download](https://sideloadly.io))
            - âœ… USB cable (Lightning/Type-C)
            - âœ… Apple ID (free account works!)
            - âœ… iTunes/Apple Devices (for Windows users)
            
            ### ğŸš€ Installation Steps
            
            #### 1ï¸âƒ£ **Download & Prepare**
            ```
            ğŸ“¥ Download Sukinime-iOS.ipa (scroll down)
            ğŸ’» Install Sideloadly from https://sideloadly.io
            ğŸ”Œ Connect iPhone/iPad to computer via USB
            ```
            
            #### 2ï¸âƒ£ **Install with Sideloadly**
            ```
            1. Open Sideloadly
            2. Your device should appear automatically
            3. Drag & drop Sukinime-iOS.ipa into Sideloadly
            4. Enter your Apple ID email
            5. Enter your Apple ID password (or app-specific password)
            6. Click "Start" button
            7. Wait for installation (~2-5 minutes)
            ```
            
            #### 3ï¸âƒ£ **Trust Certificate**
            ```
            ğŸ“± Open iPhone Settings
            â†’ General
            â†’ VPN & Device Management
            â†’ Find your Apple ID certificate
            â†’ Tap it â†’ Trust â†’ Trust again
            ```
            
            #### 4ï¸âƒ£ **Launch Sukinime** ğŸ‰
            ```
            Open the app and enjoy watching anime!
            ```
            
            ---
            
            ## âš ï¸ Important Notes
            
            ### ğŸ”„ App Expiration (7-Day Limitation)
            
            Apps installed with free Apple ID expire after **7 days**. Options:
            
            **Option 1: Re-sideload Every Week** (Recommended)
            - âœ… Simply re-install using Sideloadly every 6-7 days
            - âœ… Your watch history & settings are preserved
            - âœ… Takes only 2-3 minutes
            
            **Option 2: Use Paid Apple Developer Account**
            - ğŸ’° $99/year Apple Developer Program
            - âœ… Apps valid for 1 year
            - âœ… No weekly reinstallation needed
            
            ### ğŸ” Apple ID Security Tips
            
            **Two-Factor Authentication (2FA) Users:**
            - Use **App-Specific Password** instead of main password
            - Generate at: https://appleid.apple.com
            - Account Security â†’ App-Specific Passwords â†’ Generate
            
            **Important:**
            - âœ… Your Apple ID is only used for code signing
            - âœ… Sideloadly does NOT store your credentials
            - âœ… Your password never leaves your computer
            
            ### ğŸ’¡ Pro Tips
            
            - ğŸ“… Set a reminder for day 6 to re-sideload
            - ğŸ”‹ Keep device connected & unlocked during installation
            - ğŸ“¶ Stable internet connection recommended
            - ğŸ’¾ Watch history is stored locally (survives re-installation)
            - ğŸ¯ You can have multiple sideloaded apps simultaneously
            
            ### ğŸ› Troubleshooting
            
            **"Installation Failed"**
            ```
            âœ… Make sure device is unlocked
            âœ… Delete old Sukinime version first
            âœ… Restart Sideloadly
            âœ… Try different USB port/cable
            âœ… Update iTunes to latest version (Windows)
            ```
            
            **"Untrusted Developer"**
            ```
            âœ… Settings â†’ General â†’ VPN & Device Management
            âœ… Trust your Apple ID certificate
            âœ… Tap twice to confirm
            ```
            
            **"App Crashes on Launch"**
            ```
            âœ… Check iOS version (minimum 12.0+)
            âœ… Reinstall the app via Sideloadly
            âœ… Check internet connection
            âœ… Restart device
            ```
            
            **"Could Not Verify App"**
            ```
            âœ… Your device needs internet connection on first launch
            âœ… Certificate might be expired (re-sideload)
            âœ… Date & time must be correct
            ```
            
            ---
            
            ## ğŸ“Š Build Information
            
            | Property | Value |
            |----------|-------|
            | ğŸ·ï¸ Version | v1.0.${{ github.run_number }} |
            | ğŸ“… Build Date | ${{ github.event.head_commit.timestamp }} |
            | ğŸ”– Commit | `${{ github.sha }}` |
            | ğŸ¦‹ Flutter | 3.27.1 |
            | ğŸ iOS Min | 12.0 |
            | ğŸ“¦ Bundle ID | `com.sukinime.app` |
            | ğŸ’¾ IPA Size | ~50-80 MB |
            
            ---
            
            ## ğŸ”— Useful Links
            
            - ğŸ“¥ [Sideloadly Official](https://sideloadly.io)
            - ğŸ“– [Sideloadly Guide](https://sideloadly.io/guide)
            - ğŸ” [App-Specific Passwords](https://appleid.apple.com)
            - ğŸ’¬ [Report Issues](https://github.com/${{ github.repository }}/issues)
            - â­ [Star this Project](https://github.com/${{ github.repository }})
            
            ---
            
            ## ğŸ¥ Video Tutorial
            
            **New to Sideloadly?** Watch this guide:
            - [How to Use Sideloadly](https://www.youtube.com/results?search_query=how+to+use+sideloadly)
            
            ---
            
            ## â“ FAQ
            
            **Q: Do I need to jailbreak?**
            A: No! Sideloadly works on non-jailbroken devices.
            
            **Q: Can I use on Windows?**
            A: Yes! Sideloadly supports both Windows and macOS.
            
            **Q: Will my Apple ID get banned?**
            A: No, this is an official Apple feature for developers.
            
            **Q: Can I sideload on iPad?**
            A: Yes! Works on all iOS/iPadOS devices.
            
            **Q: Does it work offline after installation?**
            A: Yes, but first launch requires internet for verification.
            
            ---
            
            <div align="center">
            
            **Made with â¤ï¸ for Anime Lovers**
            
            *Enjoy watching your favorite anime on Sukinime!* âœ¨
            
            `#Anime #iOS #Sideloadly #Flutter #OpenSource`
            
            </div>
            
          files: build/ios/ipa/Sukinime-iOS.ipa
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # âœ… BUILD SUMMARY
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: âœ… Build Summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… SUKINIME iOS BUILD SUCCESSFUL!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“± App Name: Sukinime"
          echo "ğŸ·ï¸  Version: v1.0.${{ github.run_number }}"
          echo "ğŸ“¦ IPA Size: $(ls -lh build/ios/ipa/Sukinime-iOS.ipa | awk '{print $5}')"
          echo "ğŸ Platform: iOS 12.0+"
          echo "ğŸ“ Location: build/ios/ipa/Sukinime-iOS.ipa"
          echo ""
          echo "ğŸ‰ Ready for Sideloadly installation!"
          echo "ğŸ’¡ Download from: https://sideloadly.io"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"