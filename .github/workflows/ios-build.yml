name: iOS Build for AltStore

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-13
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install Dependencies
        run: |
          flutter pub get
          flutter doctor -v

      - name: ğŸ› ï¸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: ğŸ Build iOS App (Unsigned)
        run: |
          # Clean previous builds
          flutter clean
          
          # Build iOS without code signing
          flutter build ios --release --no-codesign
          
          # Create Payload directory
          mkdir -p Payload
          
          # Copy app bundle to Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          
          # Create IPA file
          zip -r SukiAnime-iOS.ipa Payload
          
          # Move to build directory
          mkdir -p build/ios/ipa
          mv SukiAnime-iOS.ipa build/ios/ipa/

      - name: ğŸ“¤ Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiAnime-iOS-v${{ github.run_number }}
          path: build/ios/ipa/SukiAnime-iOS.ipa
          retention-days: 30

      - name: ğŸ‰ Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ios-v1.0.${{ github.run_number }}
          name: Suki Anime iOS v1.0.${{ github.run_number }}
          body: |
            ## ğŸ“± Suki Anime - iOS Build (Unsigned)
            
            ### ğŸ“¥ Installation Instructions:
            
            **Requirements:**
            - iPhone with iOS 12.0 or higher
            - AltStore installed on iPhone
            - AltServer running on Windows PC
            - USB cable or same WiFi network
            
            **Steps:**
            1. Download the `.ipa` file below
            2. Connect iPhone to PC (USB or WiFi)
            3. Open AltServer â†’ Install App to [Your iPhone]
            4. Select the downloaded IPA file
            5. Enter your Apple ID credentials
            6. Wait for installation to complete
            7. Trust developer certificate:
               - Settings â†’ General â†’ VPN & Device Management
               - Tap your Apple ID â†’ Trust
            
            **Important:**
            - App expires every 7 days (free Apple ID limitation)
            - Keep AltServer running for auto-refresh
            - Enable Background Refresh in AltStore app
            
            ### ğŸ“ Changelog:
            - Build number: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            
            ---
            
            **Need help?** Open an issue on GitHub
            
          files: build/ios/ipa/SukiAnime-iOS.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}